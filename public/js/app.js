// Generated by CoffeeScript 1.9.3
var App, Product, ProductList, Vue, VueRouter, router;

Vue = require('Vue');

VueRouter = require('vue-router');

Vue.use(require('vue-resource'));

Vue.use(VueRouter);

Product = Vue.extend({
  template: require('jade!../../views/Product.html')(),
  data: {
    item: {
      name: 'xxxx'
    }
  },
  props: ['currency'],
  ready: function() {
    this.currency = this.$parent.currency;
    this.fx = require('money');
    this.fx.base = 'USD';
    this.$http.get("/api/rates", (function(_this) {
      return function(fx) {
        console.log('rates set');
        _this.fx.rates = fx.rates;
        return _this.$http.get("/api/products/" + _this.$route.params.id, function(item) {
          return _this.$set('item', item);
        });
      };
    })(this));
    return this.$watch('$parent.currency', (function(_this) {
      return function(newCur, oldCur) {
        var olditem;
        _this.currency = newCur;
        olditem = _this.item;
        _this.$set('item', null);
        return _this.$set('item', olditem);
      };
    })(this));
  },
  filters: {
    formatPrice: function(item, currency) {
      var baseCurrency, newPrice, price;
      console.log('sel cur: ' + currency);
      baseCurrency = currency || 'USD';
      price = item.price;
      currency = item.currency;
      if (currency === baseCurrency) {
        return price + " " + currency;
      }
      newPrice = (0 + this.fx.convert(price, {
        from: currency,
        to: baseCurrency
      })).toFixed(2);
      return newPrice + " " + baseCurrency + " (" + price + " " + currency + ")";
    }
  }
});

ProductList = Vue.extend({
  template: require('jade!../../views/ProductList.html')(),
  data: {
    title: 'blabla',
    items: []
  },
  ready: function() {
    return this.$http.get('/api/products', (function(_this) {
      return function(items, status, req) {
        return _this.$set('items', items);
      };
    })(this));
  },
  filters: {
    getVariants: function(product) {
      if (product.variants) {
        return _.keys(product.variants).length;
      } else {
        return 1;
      }
    },
    getBestPrice: function(p) {
      if (!p.price.best) {
        return "n/a";
      }
      return p.price.best.price + " " + p.price.best.currency + " (" + p.price.best.supplier + ")";
    },
    getPrice: function(product) {
      var max, min, pr, price, ref, variantId, x;
      min = 0;
      max = 0;
      if (product.variants) {
        ref = product.variants;
        for (variantId in ref) {
          x = ref[variantId];
          price = x.retail_price;
          if (price === void 0 && product.retail_price) {
            price = product.retail_price;
          }
          if (!price) {
            continue;
          }
          pr = price.CNY;
          if (pr > max) {
            max = pr;
          }
          if (pr < min || min === 0) {
            min = pr;
          }
        }
      } else if (product.retail_price) {
        max = min = product.retail_price.CNY;
      }
      if (max === 0) {
        return '';
      }
      if (max === min) {
        return max + " CNY";
      }
      return min + " - " + max + " CNY";
    }
  }
});

App = Vue.extend({
  data: function() {
    return {
      currency: 'CZK'
    };
  }
});

router = new VueRouter({
  alwaysRefresh: true
});

router.map({
  '/': {
    component: ProductList,
    alwaysRefresh: true
  },
  '/products/:id': {
    component: Product,
    alwaysRefresh: true
  }
});

window.onload = function() {
  return router.start(App, '#app');
};
